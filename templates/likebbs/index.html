{% extends "base.html" %}
{% load likebbs_tags %}

{% block title %}- いいね機能付き掲示板{% endblock %}

{% block content %}
  <h1>CRUDアプリ（いいね機能付き）</h1>
  {% for article in object_list %}
    <div class="container">
      <p>{{ article.id }}：{{ article.author}}：{{ article.created_at }}</p>
      <p><a href="{% url 'likebbs:detail' article.id %}">{{ article.content }}</a></p>
      
      <!-- いいねボタンとカウント表示 -->
      <div class="like-section">
        <!-- Ajax処理用のいいねボタン -->
        <span id="like-count-{{ article.id }}">いいね数: {{ article.like_count }}</span>
        
        {% if user.is_authenticated %}
          <!-- Ajaxでいいね処理を行う -->
          {% has_liked article user as liked %}
          <button class="like-button" data-article-id="{{ article.id }}">
            {% if liked %}
              いいね解除
            {% else %}
              いいね
            {% endif %}
          </button>
          
          <!-- フォーム送信でいいね処理を行う場合（JavaScriptが無効な場合の対応） -->
          <form action="{% url 'likebbs:like' article.id %}" method="post" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="like-button-fallback">
              {% if liked %}
                いいね解除
              {% else %}
                いいね
              {% endif %}
            </button>
          </form>
        {% endif %}
      </div>
    </div>
  {% endfor %}
  <a href="{% url 'likebbs:create' %}">新規投稿</a>
  
  <!-- Ajaxのためのスクリプト -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // いいねボタンがクリックされたときの処理
      document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', function() {
          const articleId = this.dataset.articleId;
          const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
          
          // JavaScriptを使っている場合はフォーム送信ボタンを非表示にする
          document.querySelectorAll('.like-button-fallback').forEach(btn => {
            btn.style.display = 'none';
          });
          
          // Ajaxでいいね処理を行う
          fetch(`/likebbs/api/${articleId}/like/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            // いいね数を更新
            document.getElementById(`like-count-${articleId}`).textContent = `いいね数: ${data.count}`;
            
            // ボタンのテキストを更新
            this.textContent = data.liked ? 'いいね解除' : 'いいね';
          })
          .catch(error => console.error('Error:', error));
        });
      });
    });
  </script>
{% endblock %}